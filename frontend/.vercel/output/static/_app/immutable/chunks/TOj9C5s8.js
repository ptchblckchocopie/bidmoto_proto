var h=Object.defineProperty;var u=(e,t,s)=>t in e?h(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var i=(e,t,s)=>u(e,typeof t!="symbol"?t+"":t,s);import{w as o}from"./Cl0DMWZv.js";function d(e){if(!e)return 5e3;const t=Date.now(),n=new Date(e).getTime()-t;return n<=0?1e4:n<6e4?3e3:n<36e5?5e3:1e4}class f{constructor(t){i(this,"productId");i(this,"listeners",new Set);i(this,"pollingInterval",null);i(this,"pollingTimer",null);i(this,"active",!1);i(this,"lastBidAmount",null);i(this,"lastStatus",null);i(this,"auctionEndDate");i(this,"state",o("disconnected"));i(this,"lastBid",o(null));i(this,"redisConnected",o(!1));i(this,"handleVisibilityChange",()=>{document.hidden?this.stopPolling():this.active&&(this.poll(),this.scheduleNextPoll())});this.productId=t}connect(){this.active||(this.active=!0,this.state.set("connected"),this.poll(),this.scheduleNextPoll(),document.addEventListener("visibilitychange",this.handleVisibilityChange))}scheduleNextPoll(){if(this.stopPolling(),!this.active||document.hidden)return;const t=d(this.auctionEndDate);this.pollingTimer=setTimeout(()=>{this.active&&!document.hidden&&(this.poll(),this.scheduleNextPoll())},t)}stopPolling(){this.pollingTimer&&(clearTimeout(this.pollingTimer),this.pollingTimer=null),this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null)}async poll(){try{const t=await fetch(`/api/bridge/products/${this.productId}/status`);if(t.ok){const s=await t.json();if(s.auctionEndDate&&(this.auctionEndDate=s.auctionEndDate),s.currentBid!==this.lastBidAmount){const n={type:"bid",success:!0,amount:s.currentBid,timestamp:Date.now()};this.lastBid.set(n),this.listeners.forEach(l=>l(n)),this.lastBidAmount=s.currentBid}if(s.status!==this.lastStatus&&this.lastStatus!==null&&s.status==="sold"){const n={type:"accepted",success:!0,status:"sold",amount:s.currentBid,timestamp:Date.now()};this.listeners.forEach(l=>l(n))}this.lastStatus=s.status}}catch{}}subscribe(t){return this.listeners.add(t),()=>this.listeners.delete(t)}disconnect(){this.active=!1,this.stopPolling(),document.removeEventListener("visibilitychange",this.handleVisibilityChange),this.state.set("disconnected"),this.listeners.clear()}}class p{constructor(t){i(this,"userId");i(this,"listeners",new Set);i(this,"pollingTimer",null);i(this,"active",!1);i(this,"lastUnreadCount",-1);i(this,"state",o("disconnected"));i(this,"lastMessage",o(null));i(this,"unreadCount",o(0));i(this,"handleVisibilityChange",()=>{document.hidden?this.stopPolling():this.active&&(this.poll(),this.scheduleNextPoll())});this.userId=t}connect(){this.active||(this.active=!0,this.state.set("connected"),this.poll(),this.scheduleNextPoll(),document.addEventListener("visibilitychange",this.handleVisibilityChange))}scheduleNextPoll(){this.stopPolling(),!(!this.active||document.hidden)&&(this.pollingTimer=setTimeout(()=>{this.active&&!document.hidden&&(this.poll(),this.scheduleNextPoll())},15e3))}stopPolling(){this.pollingTimer&&(clearTimeout(this.pollingTimer),this.pollingTimer=null)}async poll(){try{const t=typeof window<"u"?localStorage.getItem("auth_token"):null,s=await fetch("/api/bridge/notifications/poll",{headers:{...t?{Authorization:`JWT ${t}`}:{}}});if(s.ok){const n=await s.json();if(n.unreadCount!==this.lastUnreadCount&&this.lastUnreadCount!==-1&&n.unreadCount>this.lastUnreadCount){const l={type:"new_message",messageId:0,productId:0,senderId:0,timestamp:Date.now()};this.lastMessage.set(l),this.listeners.forEach(c=>c(l))}this.unreadCount.set(n.unreadCount),this.lastUnreadCount=n.unreadCount}}catch{}}subscribe(t){return this.listeners.add(t),()=>this.listeners.delete(t)}resetUnreadCount(){this.unreadCount.set(0),this.lastUnreadCount=0}disconnect(){this.active=!1,this.stopPolling(),document.removeEventListener("visibilitychange",this.handleVisibilityChange),this.state.set("disconnected"),this.listeners.clear()}}const a=new Map,r=new Map;function v(e){return a.has(e)||a.set(e,new f(e)),a.get(e)}function C(e){return r.has(e)||r.set(e,new p(e)),r.get(e)}function w(e){const t=a.get(e);t&&(t.disconnect(),a.delete(e))}function y(e){const t=r.get(e);t&&(t.disconnect(),r.delete(e))}async function S(e,t,s=!1){const n=typeof window<"u"?localStorage.getItem("auth_token"):null;try{const l=await fetch("/api/bridge/bid/queue",{method:"POST",headers:{"Content-Type":"application/json",...n?{Authorization:`JWT ${n}`}:{}},body:JSON.stringify({productId:typeof e=="string"?parseInt(e,10):e,amount:t,censorName:s})}),c=await l.json();return l.ok?c:{success:!1,error:c.error||"Failed to place bid"}}catch(l){return{success:!1,error:String(l)}}}export{w as a,v as b,y as d,C as g,S as q};
